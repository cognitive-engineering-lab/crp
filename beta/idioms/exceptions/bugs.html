<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Errors indicating bugs - C++ to Rust Phrasebook</title>


        <!-- Custom HTML head -->

        <meta name="description" content="A book to help translate C++ idioms into Rust.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <meta property="og:description" content="A book to help translate C++ idioms into Rust.">
        <meta property="twitter:description" content="A book to help translate C++ idioms into Rust.">
        <meta name="twitter:card" content="summary">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../custom.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">C++ to Rust Phrasebook</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/cognitive-engineering-lab/crp" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="errors-indicating-bugs"><a class="header" href="#errors-indicating-bugs">Errors indicating bugs</a></h1>
<p>In C++, exceptions are sometimes used to indicate an error that is due to a
programming bug. In many situations, no exception is produced, and instead the
invalid use of an API is simply undefined behavior.</p>
<p>In Rust, <code>panic!</code> is used for these kinds of errors, often via an
<a href="https://doc.rust-lang.org/std/result/enum.Result.html#method.expect"><code>expect</code></a>
or
<a href="https://doc.rust-lang.org/std/result/enum.Result.html#method.unwrap"><code>unwrap</code></a>
method on <code>Result</code> or <code>Option</code> or via <a href="#assertions">assertions like <code>assert!</code></a>.
While a panic in Rust may unwind the stack or abort a program, it is never
undefined behavior.</p>
<div class="comparison">
<pre><code class="language-cpp">#include &lt;cstddef&gt;
#include &lt;vector&gt;

int main() {
  std::vector&lt;int&gt; v{1, 2, 3};
  // undefined behavior!
  int x(v[4]);
}
</code></pre>
<pre><pre class="playground"><code class="language-rust no_run">fn main() {
    let v = vec![1,2,3];
    // panics!
    let x = v[4];
}</code></pre></pre>
</div>
<h2 id="converting-result-or-option-to-panic"><a class="header" href="#converting-result-or-option-to-panic">Converting <code>Result</code> or <code>Option</code> to <code>panic!</code></a></h2>
<p>It is easier to convert from a <code>Result</code> or <code>Option</code> to a panic than to go the
other way around. Therefore, many libraries in Rust are written to return
<code>Result</code> or <code>Option</code> and allow the caller to determine whether a <code>None</code> result
indicates a bug by using <code>unwrap</code> or <code>expect</code> to extract the value, panicking if
there isn't one.</p>
<pre><pre class="playground"><code class="language-rust should_panic">/// Returns `None` if the number cannot be divided evenly.
fn divide_exact(dividend: i32, divisor: i32) -&gt; Option&lt;i32&gt; {
    let quotient = dividend / divisor;
    if quotient * divisor == dividend {
        Some(quotient)
    } else {
        None
    }
}

// Returns `None` if the number cannot be divided by 2
fn divide_by_two_exact(dividend: i32) -&gt; Option&lt;i32&gt; {
    // divide_exact returning None here isn't a bug
    divide_exact(dividend, 2)
}

fn main() {
    let res = divide_exact(10, 3); // Oops, a bug!
    let x = res.unwrap();
    // ...
}</code></pre></pre>
<p>When designing an API, if only one of a <code>Result</code>-based (or <code>Option</code>-based) or
panicking interface is going to be offered, it is generally better to offer the
<code>Result</code>-based interface. That way that the caller can choose to omit the
pre-condition checks and handle the error instead or to panic because
pre-conditions should have been met.</p>
<h2 id="assertions"><a class="header" href="#assertions">Assertions</a></h2>
<p>In Rust, panics are also generated by assertions. Unlike <code>assert</code> in C++, The
<a href="https://doc.rust-lang.org/std/macro.assert.html"><code>assert!</code></a> family of macros in
Rust cannot be disabled. They are therefore appropriate for asserting invariants
when creating safe wrappers for unsafe code, in addition to checking for logical
invariants.</p>
<div class="comparison">
<pre><code class="language-cpp">#include &lt;cassert&gt;
#include &lt;cstddef&gt;

template &lt;typename T&gt;
class Widget {
  T *parts;
  std::size_t part_count;

public:
  // ... constructors ...

  /**
   * @pre n must be smaller than part_count
   */
  T get_part(std::size_t n) {
    // Unlike in Rust, this can be disabled,
    // e.g., with -DNDEBUG.
    assert(n &lt; part_count);
    return *(parts + n);
  }
};
</code></pre>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct Widget&lt;T&gt; {
    parts: *const T,
    part_count: usize,
}

impl&lt;T: Copy&gt; Widget&lt;T&gt; {
    // ... constructor methods ...

    /// Panics if n is greater than the number of
    /// parts.
    pub fn get_part(&amp;self, n: usize) -&gt; T {
        // SAFETY: Widget maintians invariant of
        // at least part_count parts, so if n is
        // less than the part count then we can
        // use it access a part.
        assert!(
            n &lt; self.part_count,
            "index {} exceeds part count {}",
            n,
            self.part_count
        );
        let idx = isize::try_from(n).expect(
            "can't convert index to offset"
        );
        unsafe { self.parts.offset(idx).read() }
    }
}
<span class="boring">}</span></code></pre></pre>
</div>
<p>The Rust <a href="https://doc.rust-lang.org/std/macro.debug_assert.html"><code>debug_assert!</code>
macro</a> is more like
<code>assert!</code> in C++, in that it can be turned off by a compilation configuration
option, and so is useful for encoding logical invariants that should be
checked during development and testing, but are too expensive to check
in production.</p>
<h3 id="other-assertion-macros"><a class="header" href="#other-assertion-macros">Other assertion macros</a></h3>
<p>Rust has several other convenience assertion macros. The macros
<a href="https://doc.rust-lang.org/std/macro.assert_eq.html"><code>assert_eq!</code></a> and
<a href="https://doc.rust-lang.org/std/macro.assert_ne.html"><code>assert_ne!</code></a> will print
their arguments on assertion failure using the <code>Debug</code> trait implementation.</p>
<p>The <a href="https://doc.rust-lang.org/std/macro.unreachable.html"><code>unreachable!</code></a> macro
is for asserting that when matching on an enum certain cases are expected to not
be possible. It is essentially <code>panic!</code> with a fixed error message, but better
communicates intent.</p>
<h3 id="static-assertions"><a class="header" href="#static-assertions">Static assertions</a></h3>
<p>C++ also has <code>static_assert</code>, which is guaranteed to be evaluated at compile
time, other than when used in templates. When used in templates, it is
guaranteed to be evaluated at compile time if the template is instantiated. In
Rust the same thing can achieved by calling <code>assert!</code> in a const block or some
other <a href="https://doc.rust-lang.org/reference/const_eval.html#const-context">constant
context</a>. The
convenience macros <code>assert_eq!</code> and <code>assert_ne!</code> cannot (yet) be used in const
contexts.</p>
<p>The following example fails to compile in both Rust and C++ with the message
from the static assertion.</p>
<div class="comparison">
<pre><code class="language-cpp">#include &lt;cassert&gt;

int main() {
  static_assert(false, "static requirement");
}
</code></pre>
<pre><pre class="playground"><code class="language-rust ignore mdbook-runnable">fn main() {
    const {
        assert!(false, "static requirement");
    }
}</code></pre></pre>
</div>
<p>Like with C++ <code>static_assert</code>, a Rust assertion in a const block in a generic
definition is only evaluated when the generic arguments are known. Both the C++
and the Rust versions of the following example only fail to compile if the
<code>first</code> function is called on an array with a size less than 1.</p>
<div class="comparison">
<pre><code class="language-cpp">#include &lt;array&gt;
#include &lt;cassert&gt;
#include &lt;cstddef&gt;

template &lt;const std::size_t n&gt;
int &amp;first(std::array&lt;int, n&gt; arr) {
  static_assert(
      n &gt;= 1,
      "array needs to have at last size 1!");
  return arr[0];
}
</code></pre>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn first&lt;const N: usize&gt;(arr: [i32; N]) -&gt; i32 {
    const {
        assert!(
            N &gt;= 1,
            "array needs to have at last size 1!"
        )
    }
    arr[0]
}
<span class="boring">}</span></code></pre></pre>
</div>
<p>In C++, <code>static_assert</code> can also be used at namespace scope. To achieve an
equivalent thing in Rust requires defining an unnamed constant.</p>
<div class="comparison">
<pre><code class="language-cpp">static_assert(true,  "top-level assert true");
static_assert(false,  "top-level assert false");

int main() {}
</code></pre>
<pre><pre class="playground"><code class="language-rust ignore mdbook-runnable">const _: () = assert!(true, "top-level assert true");
const _: () = assert!(false, "top-level assert false");

fn main() {}</code></pre></pre>
</div>
<h3 id="assertions-and-the-optimizer"><a class="header" href="#assertions-and-the-optimizer">Assertions and the optimizer</a></h3>
<p>Assertions do affect how the Rust compiler optimizes code (e.g., by enabling the
optimizer to eliminate subsequent redundant checks) but the specific effects are
not guaranteed.</p>
<h2 id="panics-in-embedded-systems"><a class="header" href="#panics-in-embedded-systems">Panics in embedded systems</a></h2>
<p>When programming in Rust for embedded systems using <code>#![no_std]</code>, there is no
default panic handler. Instead one must be specified using the
<code>#[panic_handler]</code> annotation.</p>
<p>The Embedded Rust Book <a href="https://docs.rust-embedded.org/book/start/panicking.html">chapter on handling
panics</a> has more
details on implementing panic handlers for in <code>no_std</code> programs.</p>


                        <a class="feedback-link" href="https://docs.google.com/forms/d/e/1FAIpQLScoygeNlygODY2owQ-HvU8VGx3hi50aic7ZlKCyhJ0VktjiCg/viewform?usp=pp_url&entry.1450251950=Errors indicating bugs">Click here to leave us feedback about this page.</a>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../idioms/exceptions/expected_errors.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../idioms/type_equivalents.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../idioms/exceptions/expected_errors.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../idioms/type_equivalents.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>


        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-Q3W4ES0FTM"></script>
        <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-Q3W4ES0FTM');
        </script>


        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../telemetry/dist/telemetry.iife.js"></script>


    </div>
    </body>
</html>
