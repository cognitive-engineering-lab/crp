<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Template specialization - C++ to Rust Phrasebook</title>


        <!-- Custom HTML head -->

        <meta name="description" content="A book to help translate C++ idioms into Rust.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../custom.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">C++ to Rust Phrasebook</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/cognitive-engineering-lab/crp" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="template-specialization"><a class="header" href="#template-specialization">Template specialization</a></h1>
<p>Template specialization in C++ makes it possible for a template entity to have
different implementations for different parameters. Most STL implementations
make use of this to, for example, provide a <a href="https://en.cppreference.com/w/cpp/container/vector_bool">space-efficient representation of
<code>std::vector&lt;bool&gt;</code></a>.</p>
<p>Because of the possibility of template specialization, when a C++ function
operates on values of a template class like <code>std::vector</code>, the function is
essentially defined in terms of the interface provided by the template class,
rather than for a specific implementation.</p>
<p>To accomplish the same thing in Rust requires defining the function in terms of
a trait for the interface against which it operates. This enables clients to
select their choice of representation for data by using any concrete type that
implements the interface.</p>
<p>This is more practical to do in Rust than in C++, because generics not being a
general metaprogramming facility means that <a href="./templates.html#a-note-on-type-checking-and-type-errors">generic entities can be type
checked
locally</a>,
making them easier to define. It is more common to do in Rust than in C++
because Rust does not have <a href="./inheritance_and_reuse.html">implementation
inheritance</a>, so there is a
sharper line between interface and implementation than there is in C++.</p>
<p>The following example shows how a Rust function can be implemented so that
different concrete representations can be selected by a client. For a compact
bit vector representation, the example uses the
<a href="https://docs.rs/bitvec/latest/bitvec/vec/struct.BitVec.html"><code>BitVec</code></a> type
from the <a href="https://docs.rs/bitvec/latest/bitvec/">bitvec crate</a>. <code>BitVec</code> is
intended intended to provide an API similar to <code>Vec&lt;bool&gt;</code> or
<code>std::vector&lt;bool&gt;</code>.</p>
<div class="comparison">
<pre><code class="language-cpp">#include &lt;string&gt;
#include &lt;vector&gt;

template &lt;typename T&gt;
void push_if_even(int n,
                  std::vector&lt;T&gt; &amp;collection,
                  T item) {
  if (n % 2 == 0) {
    collection.push_back(item);
  }
}

int main() {
  // Operate on the default std::vector
  // implementation
  std::vector&lt;std::string&gt; v{"a", "b"};
  push_if_even(2, v, std::string("c"));

  // Operate on the (likely space-optimized)
  // std::vector implementation
  std::vector&lt;bool&gt; bv{false, true};
  push_if_even(2, bv, false);
}
</code></pre>
<pre><code class="language-rust ignore">// The Extend trait is for types that support
// appending values to the collection.
fn push_if_even&lt;T, I: Extend&lt;T&gt;&gt;(
    n: u32,
    collection: &amp;mut I,
    item: T,
) {
    if n % 2 == 0 {
        collection.extend([item]);
    }
}

use bitvec::prelude::*;

fn main() {
    // Operate on Vec
    let mut v =
        vec!["a".to_string(), "b".to_string()];
    push_if_even(2, &amp;mut v, "c".to_string());

    // Operate on BitVec
    let mut bv = bitvec![0, 1];
    push_if_even(2, &amp;mut bv, 0);
}</code></pre>
</div>
<h2 id="trade-offs-between-generics-and-templates"><a class="header" href="#trade-offs-between-generics-and-templates">Trade-offs between generics and templates</a></h2>
<p>Because generic functions can only interact with generic values in ways defined
by the trait bounds, it is easier to test generic implementations. In
particular, code testing a generic implementation only has to consider the
possible behaviors of the given trait.</p>
<p>For a comparison, consider the following programs.</p>
<div class="comparison">
<pre><code class="language-cpp">template &lt;totally_ordered T&gt;
T max(const T &amp;x, const T &amp;y) {
  return (x &gt; y) ? x : y;
}

template &lt;&gt;
int max(const int &amp;x, const int &amp;y) {
  return (x &gt; y) ? x + 1 : y + 1;
}
</code></pre>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn max&lt;'a, T: Ord&gt;(x: &amp;'a T, y: &amp;'a T) -&gt; &amp;'a T {
    if x &gt; y {
        x
    } else {
        y
    }
}
<span class="boring">}</span></code></pre></pre>
</div>
<p>In the Rust program, <em>parametricity</em> means that (assuming safe Rust) from the
type alone one can tell that if the function returns, it must return exactly one
of <code>x</code> or <code>y</code>. This is because the trait bound <code>Ord</code> doesn't give any way to
construct new values of type <code>T</code>, and the use of references doesn't give any way
for the function to store one of <code>x</code> or <code>y</code> from an earlier call to return in a
later call.</p>
<p>In the C++ program, a call to <code>max</code> with <code>int</code> as the template parameter will
give a distinctly different result than with any other parameter because of the
template specialization enabling the behavior of the function to vary based on
the type.</p>
<p>The trade-off is that in Rust specialized implementations are harder to use
because they must have different names, but that they are easier to write
because it is easier to write generic code while being confident about its
correctness.</p>
<h2 id="niche-optimization"><a class="header" href="#niche-optimization">Niche optimization</a></h2>
<p>There are several cases where the Rust compiler will perform optimizations to
achieve more efficient representations. Those situations are all ones where the
efficiency gains do not otherwise change the observable behavior of the code.</p>
<p><a href="https://doc.rust-lang.org/std/option/index.html#representation">The most common case is with the <code>Option</code>
type</a>. When
<code>Option</code> is used with a type where the compiler can tell that there are unused
values, one f those unused values will be used to represent the <code>None</code> case, so
that <code>Option&lt;T&gt;</code> will not require an extra word of memory to indicate the
discriminant of the enum.</p>
<p>This optimization is applied to reference types (<code>&amp;</code> and <code>&amp;mut</code>), since
references cannot be null. It is also applied to <code>NonNull&lt;T&gt;</code>, which represents
a non-null pointer to a value of type <code>T</code>, and to <code>NonZeroU8</code> and other non-zero
integral types. The optimization for the reference case is what makes
<code>Option&lt;&amp;T&gt;</code> and <code>Option&lt;&amp;mut T&gt;</code> safer equivalents to using non-owning
observation pointers in C++.</p>
<div class="quiz-placeholder" data-quiz-name="&quot;template_specialization&quot;" data-quiz-questions="{&quot;questions&quot;:[{&quot;context&quot;:&quot;&gt; Both will display \&quot;Unknown type\&quot; for everything other than `int` or `i32`.\n\nIn both cases what will be displayed for other types will depend on\nimplementations/specializations elsewhere in the program.\n\n&gt; Both `displayWithType` and `display_with_type` can be called with ANY\n&gt; arguments whose types overload `&lt;&lt;` or implement `Display`.\n\nThe default function implementation `type_display_name` in the `DisplayWithType`\ntrait does not make it possible to call `display_with_type` on any type. Types\nstill need to explicitly declare that they implement the trait.\n&quot;,&quot;id&quot;:&quot;6ac15484-9038-45b7-9b47-f08918551d3a&quot;,&quot;type&quot;:&quot;MultipleChoice&quot;,&quot;answer&quot;:{&quot;answer&quot;:[&quot;Both `displayWithType` and `display_with_type` can ONLY be called with arguments\nwhose types overload `&lt;&lt;` or implement `Display`.\n&quot;]},&quot;prompt&quot;:{&quot;distractors&quot;:[&quot;Both `displayWithType` and `display_with_type` will display \&quot;Unknown type\&quot; for\neverything other than `int` or `i32`.\n&quot;,&quot;Both `displayWithType` and `display_with_type` can be called with ANY arguments\nwhose types overload `&lt;&lt;` or implement `Display`.\n&quot;],&quot;prompt&quot;:&quot;The following Rust program is an approximate translation of the C++ program.\nWhich statements are true about them?\n\nC++:\n\n```cpp\n#include &lt;iostream&gt;\n\ntemplate &lt;typename T&gt;\nvoid displayWithType(T t) {\n  std::cout &lt;&lt; \&quot;Unknown: \&quot; &lt;&lt; t &lt;&lt; std::endl;\n}\n\ntemplate &lt;&gt;\nvoid displayWithType&lt;int&gt;(int t) {\n  std::cout &lt;&lt; \&quot;int: \&quot; &lt;&lt; t &lt;&lt; std::endl;\n}\n```\n\nRust:\n\n```rust\ntrait TypeDisplayName {\n    fn type_display_name() -&gt; &amp;'static str {\n        \&quot;Unknown\&quot;\n    }\n}\n\nimpl TypeDisplayName for i32 {\n    fn type_display_name() -&gt; &amp;'static str {\n        \&quot;i32\&quot;\n    }\n}\n\nuse std::fmt::Display;\n\nfn display_with_type&lt;T: TypeDisplayName + Display&gt;(x: T) {\n    println!(\&quot;{}: {}\&quot;, T::type_display_name(), x);\n}\n```\n&quot;}},{&quot;context&quot;:&quot;`Option&lt;NonZero&lt;u32&gt;&gt;` makes use of the niche optimization.\n&quot;,&quot;id&quot;:&quot;5523ba5a-2772-4700-946e-2028471ead73&quot;,&quot;type&quot;:&quot;MultipleChoice&quot;,&quot;answer&quot;:{&quot;answer&quot;:&quot;They are all the same size.&quot;},&quot;prompt&quot;:{&quot;distractors&quot;:[&quot;```rust\nOption&lt;NonZero&lt;u32&gt;&gt;\n```\n&quot;,&quot;```rust\nNonZero&lt;u32&gt;\n```\n&quot;,&quot;```rust\nu32\n```\n&quot;],&quot;prompt&quot;:&quot;Which of the following types is the largest?\n&quot;}},{&quot;id&quot;:&quot;2f5fbeda-ab4a-48cc-92be-509d8191da0a&quot;,&quot;type&quot;:&quot;MultipleChoice&quot;,&quot;answer&quot;:{&quot;answer&quot;:&quot;```rust\nOption&lt;u32&gt;\n```\n&quot;},&quot;prompt&quot;:{&quot;distractors&quot;:[&quot;```rust\nNonZero&lt;u32&gt;\n```\n&quot;,&quot;```rust\nu32\n```\n&quot;,&quot;They are all the same size.&quot;],&quot;prompt&quot;:&quot;Which of the following types is the largest?\n&quot;}}]}" data-quiz-fullscreen="true" data-quiz-initial-text="&quot;Check your understanding&quot;"></div>
<script type="text/javascript" src="../../quiz/quiz-embed.iife.js"></script><link rel="stylesheet" type="text/css" href="../../quiz/style.css">

                        <a class="feedback-link" href="https://docs.google.com/forms/d/e/1FAIpQLScoygeNlygODY2owQ-HvU8VGx3hi50aic7ZlKCyhJ0VktjiCg/viewform?usp=pp_url&entry.1450251950=Template specialization">Click here to leave us feedback about this page.</a>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../idioms/data_modeling/templates.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../idioms/null.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../idioms/data_modeling/templates.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../idioms/null.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../telemetry/dist/telemetry.iife.js"></script>


    </div>
    </body>
</html>
